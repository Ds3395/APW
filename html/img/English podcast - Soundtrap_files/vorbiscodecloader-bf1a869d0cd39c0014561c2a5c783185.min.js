var VorbisCodec=function(){function e(){}e.loadLibrary=function(e,t,n,r){VorbisWorkerClient.instance.loadLibrary(e,t,n,r)};e.setDebug=function(e){VorbisWorkerClient.instance.debug=e};return e}();var VorbisEncoder=function(){function e(){this.client=VorbisWorkerClient.instance}e.prototype.start=function(e,t,n,r,i){var a=this;this.client.asyncCall({type:"encodeStart",sampleRate:t,channels:e,quality:n},[],function(e){if(e.success){a.handle=e.handle;r(new Uint8Array(e.buffer))}else{i(e)}})};e.prototype.encodeChunk=function(e,t,n){var r=[];for(var i=0;i<e.length;i++){r.push(e[i].buffer)}this.client.asyncCall({type:"encodeChunk",handle:this.handle,buffers:r},r,function(e){if(e.success){t(new Uint8Array(e.buffer))}else{n(e)}})};e.prototype.end=function(t,n){this.client.asyncCall({type:"encodeEnd",handle:this.handle},[],function(e){if(e.success){t(new Uint8Array(e.buffer))}else{n(e)}})};e.prototype.encodeFully=function(s,e,t,o,n,c){var u=this;var r=s.length;var l=s[0].length;var f=0;var h=5e4;var d=[];u.start(r,e,t,function(e){if(e.byteLength>0){d.push(new Uint8Array(e))}p()},c);function p(){var r=(new Date).getTime();var e=[];var t=Math.min(h,l-f);for(var n=0;n<s.length;n++){var i=s[n];var a=new Float32Array(t);a.set(new Float32Array(i.buffer,i.byteOffset+f*4,t));e.push(a)}f+=t;u.encodeChunk(e,function(e){if(e.byteLength>0){d.push(new Uint8Array(e))}if(f<l){var t=(new Date).getTime();var n=(t-r)*o;setTimeout(function(){return p()},n)}else{y()}},c)}function y(){u.end(function(e){if(e.byteLength>0){d.push(new Uint8Array(e))}n(d)},c)}};e.prototype.ping=function(e,t,n){this.client.asyncCall({type:"ping",message:e},[],function(e){if(e.success){t(e.message)}else{n(e)}})};return e}();var VorbisDecoder=function(){function e(){this.client=VorbisWorkerClient.instance}e.prototype.start=function(e,t,n){var r=this;var i=e.buffer;this.client.asyncCall({type:"decodeStart",buffer:i},[i],function(e){if(e.success){r.handle=e.handle;t(e)}else{n(e)}})};e.prototype.decodeChunk=function(e,t,i,a){this.client.asyncCall({type:"decodeChunk",handle:this.handle,offset:e,frames:t},[],function(e){if(e.success){var t=[];for(var n=0;n<e.channelData.length;n++){var r=new Float32Array(e.channelData[n]);t.push(r)}i(t)}else{a(e)}})};e.prototype.end=function(t,n){this.client.asyncCall({type:"decodeEnd",handle:this.handle},[],function(e){if(e.success){t()}else{n(e)}})};e.prototype.decodeFully=function(e,t,u,n,r){var i=this;var l;var f=0;var a=1e5;i.start(e,function(e){try{l=t.createBuffer(e.numChannels,e.numFrames,e.sampleRate);h()}catch(e){r(e)}},r);function h(){var o=(new Date).getTime();var c=Math.min(a,l.length);i.decodeChunk(null,c,function(e){for(var t=0;t<e.length;t++){var n=l.getChannelData(t);var r=new Float32Array(e[t]);n.set(r,f)}var i=e[0].length;f+=i;if(i==c){var a=(new Date).getTime();var s=(a-o)*u;setTimeout(function(){return h()},s)}else{d()}},r)}function d(){i.end(function(){n(l)},r)}};return e}();var VorbisWorkerClient=function(){function e(){this.initSuccess=false;this.initCallbacks=[];this.errorCallbacks=[];this.idCounter=1;this.requests=Object.create(null);this.debug=false}e.prototype.loadLibrary=function(e,t,n,r){if(this.worker==null){this.worker=this.createWorker(t,e);this.worker.onmessage=this.onResponse.bind(this)}if(this.initSuccess){n()}else if(this.initError!=null){r(this.initError)}else{this.initCallbacks.push(n);this.errorCallbacks.push(r)}};e.prototype.createWorker=function(e,t){var n=this;if(e){return new Worker(t)}else{var r=new FakeWorker;var i=new FakeWorker;r.peer=i;i.peer=r;var a=document.createElement("script");a.src=t;a.id="vorbisloader";a.type="application/javascript";a.addEventListener("load",function(e){VorbisWorkerScript.main(r)});a.addEventListener("error",function(e){n.handleLoadError(e)});document.head.appendChild(a);return i}};e.prototype.handleLoadError=function(t){this.initError=t;this.errorCallbacks.forEach(function(e){return e(t)});this.errorCallbacks=[];this.initCallbacks=[]};e.prototype.asyncCall=function(e,t,n){var r="VWC"+this.idCounter++;this.requests[r]=n;e.requestId=r;if(this.debug){console.log(">> "+e.type,e)}this.worker.postMessage(e,t)};e.prototype.onResponse=function(e){var t=e.data;if(this.debug){console.log("<< "+t.type,t)}switch(t.type){case"runtimeInitialized":this.initSuccess=true;this.initCallbacks.forEach(function(e){return e()});this.initCallbacks=[];break;default:var n=this.requests[t.requestId];if(n!=null){n(t);delete this.requests[t.requestId]}break}};e.instance=new e;return e}();var FakeWorker=function(){function e(){this.onmessage=function(e){}}e.prototype.postMessage=function(e,t){if(this.peer!=null){var n=Object.create(null);n.data=e;this.peer.onmessage(n)}};e.prototype.terminate=function(){};e.prototype.addEventListener=function(e,t,n){};e.prototype.dispatchEvent=function(e){return undefined};e.prototype.removeEventListener=function(e,t,n){};return e}();
