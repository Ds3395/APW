var VorbisCodec=function(){function e(){}e.loadLibrary=function(e,t,n,r){VorbisWorkerClient.instance.loadLibrary(e,t,n,r)};e.setDebug=function(e){VorbisWorkerClient.instance.debug=e};return e}();var VorbisEncoder=function(){function e(){this.client=VorbisWorkerClient.instance}e.prototype.start=function(e,t,n,r,i){var a=this;this.client.asyncCall({type:"encodeStart",sampleRate:t,channels:e,quality:n},[],function(e){if(e.success){a.handle=e.handle;r(new Uint8Array(e.buffer))}else{i(e)}})};e.prototype.encodeChunk=function(e,t,n){var r=[];for(var i=0;i<e.length;i++){r.push(e[i].buffer)}this.client.asyncCall({type:"encodeChunk",handle:this.handle,buffers:r},r,function(e){if(e.success){t(new Uint8Array(e.buffer))}else{n(e)}})};e.prototype.end=function(e,t){this.client.asyncCall({type:"encodeEnd",handle:this.handle},[],function(n){if(n.success){e(new Uint8Array(n.buffer))}else{t(n)}})};e.prototype.encodeFully=function(e,t,n,r,i,a){var s=this;var o=e.length;var c=e[0].length;var u=0;var l=5e4;var f=[];s.start(o,t,n,function(e){if(e.byteLength>0){f.push(new Uint8Array(e))}h()},a);function h(){var t=(new Date).getTime();var n=[];var i=Math.min(l,c-u);for(var o=0;o<e.length;o++){var p=e[o];var y=new Float32Array(i);y.set(new Float32Array(p.buffer,p.byteOffset+u*4,i));n.push(y)}u+=i;s.encodeChunk(n,function(e){if(e.byteLength>0){f.push(new Uint8Array(e))}if(u<c){var n=(new Date).getTime();var i=(n-t)*r;setTimeout(function(){return h()},i)}else{d()}},a)}function d(){s.end(function(e){if(e.byteLength>0){f.push(new Uint8Array(e))}i(f)},a)}};e.prototype.ping=function(e,t,n){this.client.asyncCall({type:"ping",message:e},[],function(e){if(e.success){t(e.message)}else{n(e)}})};return e}();var VorbisDecoder=function(){function e(){this.client=VorbisWorkerClient.instance}e.prototype.start=function(e,t,n){var r=this;var i=e.buffer;this.client.asyncCall({type:"decodeStart",buffer:i},[i],function(e){if(e.success){r.handle=e.handle;t(e)}else{n(e)}})};e.prototype.decodeChunk=function(e,t,n,r){this.client.asyncCall({type:"decodeChunk",handle:this.handle,offset:e,frames:t},[],function(e){if(e.success){var t=[];for(var i=0;i<e.channelData.length;i++){var a=new Float32Array(e.channelData[i]);t.push(a)}n(t)}else{r(e)}})};e.prototype.end=function(e,t){this.client.asyncCall({type:"decodeEnd",handle:this.handle},[],function(n){if(n.success){e()}else{t(n)}})};e.prototype.decodeFully=function(e,t,n,r,i){var a=this;var s;var o=0;var c=1e5;a.start(e,function(e){try{s=t.createBuffer(e.numChannels,e.numFrames,e.sampleRate);u()}catch(e){i(e)}},i);function u(){var e=(new Date).getTime();var t=Math.min(c,s.length);a.decodeChunk(null,t,function(r){for(var i=0;i<r.length;i++){var a=s.getChannelData(i);var c=new Float32Array(r[i]);a.set(c,o)}var f=r[0].length;o+=f;if(f==t){var h=(new Date).getTime();var d=(h-e)*n;setTimeout(function(){return u()},d)}else{l()}},i)}function l(){a.end(function(){r(s)},i)}};return e}();var VorbisWorkerClient=function(){function e(){this.initSuccess=false;this.initCallbacks=[];this.errorCallbacks=[];this.idCounter=1;this.requests=Object.create(null);this.debug=false}e.prototype.loadLibrary=function(e,t,n,r){if(this.worker==null){this.worker=this.createWorker(t,e);this.worker.onmessage=this.onResponse.bind(this)}if(this.initSuccess){n()}else if(this.initError!=null){r(this.initError)}else{this.initCallbacks.push(n);this.errorCallbacks.push(r)}};e.prototype.createWorker=function(e,t){var n=this;if(e){return new Worker(t)}else{var r=new FakeWorker;var i=new FakeWorker;r.peer=i;i.peer=r;var a=document.createElement("script");a.src=t;a.id="vorbisloader";a.type="application/javascript";a.addEventListener("load",function(e){VorbisWorkerScript.main(r)});a.addEventListener("error",function(e){n.handleLoadError(e)});document.head.appendChild(a);return i}};e.prototype.handleLoadError=function(e){this.initError=e;this.errorCallbacks.forEach(function(t){return t(e)});this.errorCallbacks=[];this.initCallbacks=[]};e.prototype.asyncCall=function(e,t,n){var r="VWC"+this.idCounter++;this.requests[r]=n;e.requestId=r;if(this.debug){console.log(">> "+e.type,e)}this.worker.postMessage(e,t)};e.prototype.onResponse=function(e){var t=e.data;if(this.debug){console.log("<< "+t.type,t)}switch(t.type){case"runtimeInitialized":this.initSuccess=true;this.initCallbacks.forEach(function(e){return e()});this.initCallbacks=[];break;default:var n=this.requests[t.requestId];if(n!=null){n(t);delete this.requests[t.requestId]}break}};e.instance=new e;return e}();var FakeWorker=function(){function e(){this.onmessage=function(e){}}e.prototype.postMessage=function(e,t){if(this.peer!=null){var n=Object.create(null);n.data=e;this.peer.onmessage(n)}};e.prototype.terminate=function(){};e.prototype.addEventListener=function(e,t,n){};e.prototype.dispatchEvent=function(e){return undefined};e.prototype.removeEventListener=function(e,t,n){};return e}();
